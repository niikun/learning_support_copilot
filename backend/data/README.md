# AI_engineering_day3
Home work of AI engineering Day3  　　

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/drive/1UnIcotyGpjPKkACjjZzrpxiZ6DiU7T3T?usp=sharing)　　


## 目的
- 演習で利用したコードをベースに、独自の質問と参照文書を用いて実験を行い、RAGの効果を定量的・定性的に評価する。
- 参照文書のどの位置に答えがあるかが、精度に大きく影響することを確認する。
- 参照文書と質問で異なった単語を使った場合の影響を確認する。
  
## 質問設計の観点と意図  
### テーマは「大谷翔平選手」、「大阪・関西万博」を選んだ
その意図は以下の点です。
- テーマとしてWeb上に多くの情報があり、RAGがなくても一部回答できるテーマである。
- Web上で間違った情報があるテーマである。
  - 過去の間違った報道が出ている可能性があるもの
  - 万博については、過去の万博の情報も残っている
- 明確にLLMが学んでいない情報が特定できるテーマである。

### 質問については以下の点を意図した  
- 質問の答えに必要な事項が、参照文書内で、距離がある場所に記載されている場合と記載をまとめた場合を比較する。
- 質問に使う言葉と参照文書で使っている言葉が違っている場合を比較する。

## RAGの実装方法と工夫点  
### RAGの実装について  
以下のモデルを実装し比較した。
- RAG なし
- SimpleRAG
  - 分割方法: 「。」（句点）で区切られた文単位でテキストを分割
  - 検索手法: シンプルな類似度ベースの検索でクエリに関連する文を参照文章として抽出
- Context RAG
  - 分割方法: 「。」（句点）で区切られた文単位でテキストを分割
  - 検索手法: マッチした文を中心に前2文、後2文を含む計5文程度のチャンクを参照文章として抽出
- Rerank RAG
  -  分割方法: 「。」（句点）で区切られた文単位でテキストを分割
  - 検索手法: マッチした文に対して、LLMを活用した高度な関連性評価を実施し、牽連性の高いものを参照文書として抽出
    
### 工夫点  
- コードの整理
  - テーマ、質問に対して簡単に実験できるようにコードを整理 
- 結果の見える化
  - 結果が一目でわかるようにノートブック上で可視化
  - RAGのreferenceも都度確認できるようにした 

## 結果の分析と考察  
### 実験結果  
| テーマ           | 参照文章     | 質問                               |   no_rag   | simple_rag | contex_rag | rerank_rag |
|------------------|--------------|------------------------------------|:-----------:|:-----------:|:-----------:|:-----------:|
| 大谷翔平         | 参照文章①   | 大谷翔平の職業は何ですか？         | 2      | 2          | 2          | 2          |
| 大谷翔平         | 参照文章①   | 2024年の競技外収入は何位ですか？   | 0      | 4          | 4          | 4          |
| 大谷翔平         | 参照文章①   | 配偶者の名前と過去のスポーツ経験   | 0      | 4          | 4          | 0          |
| 大谷翔平         | 参照文章①   | 妻の名前と過去のスポーツ経験       | 0      | 2          | 4          | 0          |
| 大谷翔平         | 参照文章②   | 配偶者の名前と過去のスポーツ経験   | 0      | 4          | 4          | 4          |
| 大谷翔平         | 参照文章②   | 妻の名前と過去のスポーツ経験       | 0      | 4          | 0          | 4          |
| 大阪・関西万博   | 参照文章③   | 大阪・関西万博の会場               | 0      | 3          | 3          | 3          |
| 大阪・関西万博   | 参照文章③   | 大阪・関西万博のメインキャラクター | 0      | 0          | 4          | 0          |
| 大阪・関西万博   | 参照文章③   | 大阪・関西万博のマスコット         | 0      | 4          | 4          | 0          |　　

  
※各モデルのスコアは講座のgpt4ominiを使った評価。  

### 大谷翔平   
  
**大谷翔平の職業は何ですか？**  
- no_rag で、大谷翔平の（）の中に誤記がでている。元プロ野球選手で現在はMLBなど詳細情報は取れている。  
- そのほかの手法はそれぞれ問題なく出力できている。
    
![image](https://github.com/user-attachments/assets/a58713af-6bae-43ce-98ea-acc47594bc58)  

**2024年の競技外収入は何位ですか？**  
- context_ragは２の評価だが、文章に詳細が入っているためであり、実際は４が妥当のため修正。
![image](https://github.com/user-attachments/assets/cc86aa5e-d2c7-463e-88ce-1d4046fc3b08)  

**配偶者の名前と過去のスポーツ経験**   
- simple_rag,context_ragはそれぞれ真美子さんの名前、元女子バスケット選手であることを情報記載の場所が違うにも関わらず取得できている。
  - simple_rag  
    [reference]
      *大谷 翔平（おおたに しょうへい、1994年〈平成6年〉7月5日 - ）は、岩手県水沢市（現：奥州市）出身のプロ野球選手（投手、指名打者、外野手）
      *妻は日本の元女子バスケットボール選手である
      *2021年から4年連続で日本人の好きなスポーツ選手で1位を獲得した
      *2023年12月にロサンゼルス・ドジャースと当時スポーツ史上最高額となる10年総額7億ドル（約1015億円）の契約を結んだ
      *2024年に真美子さんとの結婚  
  - context_rag  
    [reference]
      *大谷 翔平（おおたに しょうへい、1994年〈平成6年〉7月5日 - ）は、岩手県水沢市（現：奥州市）出身のプロ野球選手（投手、指名打者、外野手）。右投左打。MLBのロサンゼルス・ドジャース所属  
      *右投左打。MLBのロサンゼルス・ドジャース所属。妻は日本の元女子バスケットボール選手である。ポジションはセンター。多くの野球関係者から、史上最高の野球選手の1人と評価されている  
      *MLBにおける通算本塁打数（現：225本、2024年終了時）、シーズン本塁打数（54本、2024年）、シーズン打点（130打点、2024年）、シーズン盗塁数（59個、2024年）のアジア人記録保持者。2021年、タイム誌による「世界で最も影響力のある100人」に、「アイコン（象徴）」のカテゴリーで選出された。2021年から4年連続で日本人の好きなスポーツ選手で1位を獲得した。2023年に開催されたワールド・ベースボール・クラシックでは、日本の優勝に貢献、自身もMVPを受賞した。2023年12月にロサンゼルス・ドジャースと当時スポーツ史上最高額となる10年総額7億ドル（約1015億円）の契約を結んだ  
      *2021年から4年連続で日本人の好きなスポーツ選手で1位を獲得した。2023年に開催されたワールド・ベースボール・クラシックでは、日本の優勝に貢献、自身もMVPを受賞した。2023年12月にロサンゼルス・ドジャースと当時スポーツ史上最高額となる10年総額7億ドル（約1015億円）の契約を結んだ。2024年に真美子さんとの結婚。ドジャーズ移籍1年目は打者で出場  
      *2023年に開催されたワールド・ベースボール・クラシックでは、日本の優勝に貢献、自身もMVPを受賞した。2023年12月にロサンゼルス・ドジャースと当時スポーツ史上最高額となる10年総額7億ドル（約1015億円）の契約を結んだ。2024年に真美子さんとの結婚。ドジャーズ移籍1年目は打者で出場。元通訳との離別、前人未踏の「50-50（50本塁打、50盗塁）」達成など激動のシーズンとなった  
- rerank_ragも女子バスケットボール選手であることは取得できているが、名前は取得できず、Seiichiro Ukitaの娘という誤記がある。
    
![image](https://github.com/user-attachments/assets/05754ff0-6a75-4545-b79b-6515be47f827)  


**妻の名前と過去のスポーツ経験**   
- simple_ragで妻に対して、名前を取得できていない。referenceとしては名前が取れているので、妻と結婚を結びつけることができなかったためか？  
  - simple_rag    
    [references]   
      *大谷 翔平（おおたに しょうへい、1994年〈平成6年〉7月5日 - ）は、岩手県水沢市（現：奥州市）出身のプロ野球選手（投手、指名打者、外野手）  
      *妻は日本の元女子バスケットボール選手である  
      *2021年から4年連続で日本人の好きなスポーツ選手で1位を獲得した  
      *2024年に真美子さんとの結婚  
      *MLBのロサンゼルス・ドジャース所属  
- context_ragで"真美子さん（Shiomiko）"という誤記がある。
- rerankについては名前が取得できず、"Hikari Yamamoto"という誤記がある。
  
![image](https://github.com/user-attachments/assets/eea89631-5a24-4c4c-b6de-ccb531e6dd34)   
  
**参照文書②配偶者の名前と過去のスポーツ経験**   
- 名前と過去のスポーツ経験の記載をまとめることで、３つのRAGモデルすべてで名前、女子バスケットボール選手であったことが取得できている。  
- 実質３つとも４と判定できる。
  
![image](https://github.com/user-attachments/assets/4a99ba6a-d971-4dcc-84c3-480b90ee7ee9)  

**参照文書②妻の名前と過去のスポーツ経験**   
- 名前と過去のスポーツ経験の記載をまとめることで、３つのRAGモデルすべてで名前、女子バスケットボール選手であったことが取得できている。
- context_ragで、"真美子さん（Mami-san）"という誤記がある。
- rerankは４、context_ragは０とする。
  
![image](https://github.com/user-attachments/assets/ec0a7c40-f591-425c-b3c6-9b3a30501f32)  

### 大阪・関西万博    
**大阪・関西万博の会場**     
- RAGなしでは、大阪・関西万博について、７０年万博の答えを出している。
  
![image](https://github.com/user-attachments/assets/9001335d-66b9-4292-9593-03cf1425c252)   

**大阪・関西万博のメインキャラクター**   
- 文中でミャクミャクをマスコットと記載しているため、前後の文脈を読むcontext_rag以外は答えられていない。
- simple_ragは、キャラクターの名前は答えず、参照文書で記載されている「カラフルで親しみやすいキャラクター」と答えている。  
  
![image](https://github.com/user-attachments/assets/d62b88ad-4d21-4e64-805e-01ba31c15036)　　

**大阪・関西万博のマスコット**   
- マスコットとして訪ねた場合は、期待通り、simple_rag、context_ragは答えられている。
- rerank_ragについては、referenceが０件になってしまい、no_ragと同じ結果を返している。  

![image](https://github.com/user-attachments/assets/c15b9db6-450d-4fcc-816b-d0af3d83ac79)  

## 結論
- 参照文書について  
  - 関連する事項はできるだけまとめる（真美子さんの名前と経歴）  
  - 質問の単語と関連文書の単語が異なると、情報の取得を失敗することがある（マスコットとキャラクター）  
  - 概念上同じ単語を、解釈しきれないことがある（結婚と妻）  
- モデルについて  
  - chunkサイズが大きいcontext_ragが前後の文書も取ってくることができ、評価が高かった。   
  - rerankについては、ランク付けした結果、referenceが０件になるなど、ランクのつけ方に改善の余地がある。  
  

## 発展的な改善案
### 1回の検索・生成だけではうまくいかない
  - 結婚と妻を関連付けられなかったりしたが、複数回LLMを通すことで改善されるのではないか。
  - RAGで回答が見つけられなかった場合、ハルシネーションがいくつか見られた。
  - そもそも、参照文書がAIにとって、検索しにくいと思われる。参照文書のより良い形式を探ることで、RAGの精度を向上が期待できる。
### 以下の手法を実験。
  - RAGとWeb検索をツールに持つAgentモデル
    https://colab.research.google.com/drive/1SteQdfrIkl75ZVs3WioM_ZZ28CaTxFjU?usp=sharing
  - DualRAGを参考にした検索・要約を繰り返すモデル
    https://colab.research.google.com/drive/1gHsPOMPRXlh1GRDwXdLQgHDlROsQrXA2?usp=sharing　
